<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format Parsing Test - Brief Parser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .test-case {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case h2 {
            margin-top: 0;
            color: #4A90E2;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        code {
            font-family: 'Courier New', monospace;
        }
        .summary {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Format Parsing Test</h1>
    <p>Testing that parseEmailOutput handles numbered prefixes (1), 2), 3)) correctly</p>
    
    <div id="results"></div>

    <script src="../../src/generation/validator.js"></script>
    <script>
        const { parseEmailOutput } = window.EmailValidator;

        function runTests() {
            const results = document.getElementById('results');
            let passCount = 0;
            let failCount = 0;

            // Test 1: Output with numbered prefixes (broken format)
            const testCase1 = {
                name: "Test 1: Numbered prefixes in section headers",
                description: "LLM outputs '1) Ð¢Ð•ÐœÐ', '2) ÐŸÐ Ð•Ð¥Ð•Ð”Ð•Ð ', '3) Ð“Ð›ÐÐ’ÐÐ«Ð™ Ð‘ÐÐÐÐ•Ð ' - should still parse correctly",
                input: `1) Ð¢Ð•ÐœÐ â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒÑÐºÐ¸Ðµ Ð²Ð¸Ð½Ð½Ñ‹Ðµ Ð²ÐµÑ‡ÐµÑ€Ð°
2. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine Ð² Ñ„ÐµÐ²Ñ€Ð°Ð»Ðµ
3. ÐŸÐ»Ð°Ð½Ñ‹ Ð½Ð° 14 Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ Ð¸ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾

2) ÐŸÐ Ð•Ð¥Ð•Ð”Ð•Ð  â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. 5 Ð¸Ð´ÐµÐ¹ Ð½Ð° Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ
2. ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ â€” ÑÐºÐ¸Ð´ÐºÐ° 20%
3. Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÐ°, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸

3) Ð“Ð›ÐÐ’ÐÐ«Ð™ Ð‘ÐÐÐÐ•Ð :
Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°Ñ…: Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ð¹ Ð¿Ð»Ð°Ð½
2. Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸ Ð¿Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸ÑŽ
3. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine: Ð¿Ð¾Ð´Ð±Ð¾Ñ€ÐºÐ° Ð¸Ð´ÐµÐ¹

ÐŸÐ¾Ð´Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð”ÐµÐ³ÑƒÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¾Ð¼
2. Ð˜Ð´ÐµÐ¸ Ð´Ð»Ñ Ð²ÑÑ‚Ñ€ÐµÑ‡ Ñ Ð²Ð¸Ð½Ð¾Ð¼
3. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Ð¸ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ð¹`,
                expectedCounts: {
                    subject: 3,
                    preheader: 3,
                    bannerTitle: 3,
                    bannerSubtitle: 3
                }
            };

            // Test 2: Correct format without prefixes (OUTPUT_CONTRACT format)
            const testCase2 = {
                name: "Test 2: Correct format (OUTPUT_CONTRACT)",
                description: "Exact OUTPUT_CONTRACT format with em-dash (â€”) - should parse perfectly",
                input: `Ð¢Ð•ÐœÐ â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒÑÐºÐ¸Ðµ Ð²Ð¸Ð½Ð½Ñ‹Ðµ Ð²ÐµÑ‡ÐµÑ€Ð°
2. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine Ð² Ñ„ÐµÐ²Ñ€Ð°Ð»Ðµ
3. ÐŸÐ»Ð°Ð½Ñ‹ Ð½Ð° 14 Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ Ð¸ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾

ÐŸÐ Ð•Ð¥Ð•Ð”Ð•Ð  â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. 5 Ð¸Ð´ÐµÐ¹ Ð½Ð° Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ
2. ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ â€” ÑÐºÐ¸Ð´ÐºÐ° 20%
3. Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÐ°, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸

Ð“Ð›ÐÐ’ÐÐ«Ð™ Ð‘ÐÐÐÐ•Ð :
Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°Ñ…: Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ð¹ Ð¿Ð»Ð°Ð½
2. Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸ Ð¿Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸ÑŽ
3. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine: Ð¿Ð¾Ð´Ð±Ð¾Ñ€ÐºÐ° Ð¸Ð´ÐµÐ¹

ÐŸÐ¾Ð´Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº â€” 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð”ÐµÐ³ÑƒÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¾Ð¼
2. Ð˜Ð´ÐµÐ¸ Ð´Ð»Ñ Ð²ÑÑ‚Ñ€ÐµÑ‡ Ñ Ð²Ð¸Ð½Ð¾Ð¼
3. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Ð¸ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ð¹`,
                expectedCounts: {
                    subject: 3,
                    preheader: 3,
                    bannerTitle: 3,
                    bannerSubtitle: 3
                }
            };

            // Test 3: Wrong symbols (colon instead of em-dash)
            const testCase3 = {
                name: "Test 3: Wrong separator (colon : instead of em-dash â€”)",
                description: "LLM uses colon instead of em-dash - should FAIL (this is what was broken before)",
                input: `Ð¢Ð•ÐœÐ: 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒÑÐºÐ¸Ðµ Ð²Ð¸Ð½Ð½Ñ‹Ðµ Ð²ÐµÑ‡ÐµÑ€Ð°
2. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine Ð² Ñ„ÐµÐ²Ñ€Ð°Ð»Ðµ
3. ÐŸÐ»Ð°Ð½Ñ‹ Ð½Ð° 14 Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ Ð¸ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾

ÐŸÐ Ð•Ð¥Ð•Ð”Ð•Ð : 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. 5 Ð¸Ð´ÐµÐ¹ Ð½Ð° Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ
2. ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ â€” ÑÐºÐ¸Ð´ÐºÐ° 20%
3. Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÐ°, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸

Ð“Ð›ÐÐ’ÐÐ«Ð™ Ð‘ÐÐÐÐ•Ð :
Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº: 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°Ñ…: Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ð¹ Ð¿Ð»Ð°Ð½
2. Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸ Ð¿Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸ÑŽ
3. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine: Ð¿Ð¾Ð´Ð±Ð¾Ñ€ÐºÐ° Ð¸Ð´ÐµÐ¹`,
                expectedCounts: {
                    subject: 0, // Should fail - wrong format
                    preheader: 0,
                    bannerTitle: 0,
                    bannerSubtitle: 0
                }
            };

            // Test 4: Hyphen instead of em-dash (common mistake)
            const testCase4 = {
                name: "Test 4: Hyphen (-) instead of em-dash (â€”)",
                description: "Parser should accept regular hyphen as fallback",
                input: `Ð¢Ð•ÐœÐ - 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒÑÐºÐ¸Ðµ Ð²Ð¸Ð½Ð½Ñ‹Ðµ Ð²ÐµÑ‡ÐµÑ€Ð°
2. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine Ð² Ñ„ÐµÐ²Ñ€Ð°Ð»Ðµ
3. ÐŸÐ»Ð°Ð½Ñ‹ Ð½Ð° 14 Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ Ð¸ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾

ÐŸÐ Ð•Ð¥Ð•Ð”Ð•Ð  - 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. 5 Ð¸Ð´ÐµÐ¹ Ð½Ð° Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ
2. ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ â€” ÑÐºÐ¸Ð´ÐºÐ° 20%
3. Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÐ°, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸

Ð“Ð›ÐÐ’ÐÐ«Ð™ Ð‘ÐÐÐÐ•Ð :
Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº - 3 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
1. Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°Ñ…: Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ð¹ Ð¿Ð»Ð°Ð½
2. Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸ Ð¿Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸ÑŽ
3. Ð’ÐµÑ‡ÐµÑ€Ð° SimpleWine: Ð¿Ð¾Ð´Ð±Ð¾Ñ€ÐºÐ° Ð¸Ð´ÐµÐ¹`,
                expectedCounts: {
                    subject: 3,
                    preheader: 3,
                    bannerTitle: 3,
                    bannerSubtitle: 0
                }
            };

            const testCases = [testCase1, testCase2, testCase3, testCase4];

            testCases.forEach(test => {
                const result = parseEmailOutput(test.input);
                
                const passed = 
                    result.subject.length === test.expectedCounts.subject &&
                    result.preheader.length === test.expectedCounts.preheader &&
                    result.bannerTitle.length === test.expectedCounts.bannerTitle &&
                    result.bannerSubtitle.length === test.expectedCounts.bannerSubtitle;

                if (passed) passCount++;
                else failCount++;

                const html = `
                    <div class="test-case">
                        <h2>${test.name}</h2>
                        <p><em>${test.description}</em></p>
                        <pre><code>${test.input.substring(0, 300)}...</code></pre>
                        <div class="result ${passed ? 'pass' : 'fail'}">
                            ${passed ? 'âœ“ PASS' : 'âœ— FAIL'}
                            <br>
                            Expected: Subject=${test.expectedCounts.subject}, Preheader=${test.expectedCounts.preheader}, BannerTitle=${test.expectedCounts.bannerTitle}, BannerSubtitle=${test.expectedCounts.bannerSubtitle}
                            <br>
                            Got: Subject=${result.subject.length}, Preheader=${result.preheader.length}, BannerTitle=${result.bannerTitle.length}, BannerSubtitle=${result.bannerSubtitle.length}
                        </div>
                        ${!passed ? `<pre><code>${JSON.stringify(result, null, 2)}</code></pre>` : ''}
                    </div>
                `;
                
                results.innerHTML += html;
            });

            // Summary
            const summary = `
                <div class="summary" style="color: ${failCount === 0 ? '#155724' : '#721c24'}; background: ${failCount === 0 ? '#d4edda' : '#f8d7da'}">
                    ${failCount === 0 ? 'âœ“' : 'âœ—'} ${passCount}/${testCases.length} tests passed
                </div>
            `;
            results.innerHTML = summary + results.innerHTML;
        }

        // Run tests on load
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
