<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validator Tests - Brief Parser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f9fafb;
        }
        h1 {
            color: #1f2937;
        }
        .test-result {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            font-family: monospace;
        }
        .test-pass {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .test-fail {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .test-error {
            margin-left: 2rem;
            color: #7f1d1d;
            font-size: 0.9rem;
        }
        .summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .summary h2 {
            margin-top: 0;
        }
        .stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        .stat {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .stat.pass { color: #10b981; }
        .stat.fail { color: #ef4444; }
    </style>
</head>
<body>
    <h1>ðŸ“‹ Validator Test Suite</h1>
    <div id="results"></div>
    <div class="summary" id="summary"></div>

    <script src="../src/generation/validator.js"></script>
    <script>
        const results = document.getElementById('results');
        const summary = document.getElementById('summary');
        let passed = 0;
        let failed = 0;

        function test(name, fn) {
            const resultDiv = document.createElement('div');
            try {
                fn();
                resultDiv.className = 'test-result test-pass';
                resultDiv.textContent = `âœ“ ${name}`;
                passed++;
            } catch (error) {
                resultDiv.className = 'test-result test-fail';
                resultDiv.innerHTML = `âœ— ${name}<div class="test-error">${error.message}</div>`;
                failed++;
            }
            results.appendChild(resultDiv);
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }

        // Run tests
        const { validateEmail } = window.EmailValidator;

        test('Detects forbidden "Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸Ñ" without allowed pattern', () => {
            const text = 'ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐ°ÐµÐ¼ Ð½Ð° Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸ÑŽ Ð²Ð¸Ð½ Ð˜Ñ‚Ð°Ð»Ð¸Ð¸';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_DEGUSTATSIYA');
            assert(violation, 'Should detect forbidden Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸Ñ');
        });

        test('Allows "Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸Ñ" in correct pattern', () => {
            const text = 'ÐœÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸ÐµÐ¹ Ð²Ð¸Ð½ Ð¤Ñ€Ð°Ð½Ñ†Ð¸Ð¸';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_DEGUSTATSIYA');
            assert(!violation, 'Should allow Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ Ñ Ð´ÐµÐ³ÑƒÑÑ‚Ð°Ñ†Ð¸ÐµÐ¹ Ð²Ð¸Ð½');
        });

        test('Detects forbidden "ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ" without Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°', () => {
            const text = 'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð²Ð¸Ð½Ð¾ ÑÐ¾ ÑÐºÐ¸Ð´ÐºÐ¾Ð¹';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_KUPIT');
            assert(violation, 'Should detect forbidden ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ');
        });

        test('Allows "ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ" with Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐ°', () => {
            const text = 'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐµ SimpleWine';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_KUPIT');
            assert(!violation, 'Should allow ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ Ð² Ð²Ð¸Ð½Ð¾Ñ‚ÐµÐºÐµ');
        });

        test('Detects forbidden "Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°"', () => {
            const text = 'ÐŸÑ€Ð¸ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐµ Ð´Ð²ÑƒÑ… Ð±ÑƒÑ‚Ñ‹Ð»Ð¾Ðº';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_POKUPKA');
            assert(violation, 'Should detect forbidden Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°');
        });

        test('Detects forbidden "Ð±ÑƒÐºÐµÑ‚"', () => {
            const text = 'Ð˜Ð·Ñ‹ÑÐºÐ°Ð½Ð½Ñ‹Ð¹ Ð±ÑƒÐºÐµÑ‚ ÐºÑ€Ð°ÑÐ½Ð¾Ð³Ð¾ Ð²Ð¸Ð½Ð°';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_BUKET');
            assert(violation, 'Should detect forbidden Ð±ÑƒÐºÐµÑ‚');
        });

        test('Detects forbidden "Ð¿Ð¾ÑÐ»ÐµÐ²ÐºÑƒÑÐ¸Ðµ"', () => {
            const text = 'Ð”Ð¾Ð»Ð³Ð¾Ðµ Ð¿Ð¾ÑÐ»ÐµÐ²ÐºÑƒÑÐ¸Ðµ';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'FORBIDDEN_POSLEVKUSIE');
            assert(violation, 'Should detect forbidden Ð¿Ð¾ÑÐ»ÐµÐ²ÐºÑƒÑÐ¸Ðµ');
        });

        test('Detects subject exceeding 30 chars', () => {
            const text = 'Ð­Ñ‚Ð¾Ñ‚ Ð¾Ñ‡ÐµÐ½ÑŒ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { 
                variantCounts: { subject: 1 }, 
                limits: { subject: 30 } 
            });
            const violation = result.violations.find(v => v.code === 'CHAR_LIMIT_EXCEEDED');
            assert(violation, 'Should detect char limit exceeded');
        });

        test('Allows subject within 30 chars', () => {
            const text = 'ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { 
                variantCounts: { subject: 1 }, 
                limits: { subject: 30 } 
            });
            const violation = result.violations.find(v => v.code === 'CHAR_LIMIT_EXCEEDED');
            assert(!violation, 'Should allow text within limit');
        });

        test('Detects banned clichÃ© "Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð¾Ð²Ð¾Ð´"', () => {
            const text = 'ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð¾Ð²Ð¾Ð´ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'BANNED_CLICHE');
            assert(violation, 'Should detect banned clichÃ©');
        });

        test('Detects insufficient subject variants', () => {
            const text = `Ð¢Ð•ÐœÐ\n1. ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚`;
            const result = validateEmail(text, {}, { variantCounts: { subject: 3 } });
            const violation = result.violations.find(v => v.code === 'VARIANT_COUNT_INSUFFICIENT');
            assert(violation, 'Should detect insufficient variants');
        });

        test('Accepts correct variant count', () => {
            const text = `Ð¢Ð•ÐœÐ\n1. ÐŸÐµÑ€Ð²Ñ‹Ð¹\n2. Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹\n3. Ð¢Ñ€ÐµÑ‚Ð¸Ð¹`;
            const result = validateEmail(text, {}, { variantCounts: { subject: 3 } });
            const violation = result.violations.find(v => v.code === 'VARIANT_COUNT_INSUFFICIENT' && v.location === 'subject');
            assert(!violation, 'Should accept correct variant count');
        });

        test('Detects geography label misuse "ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÐŸÑŒÐµÐ¼Ð¾Ð½Ñ‚"', () => {
            const text = 'ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÐŸÑŒÐµÐ¼Ð¾Ð½Ñ‚';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'GEOGRAPHY_LABEL_MISUSE');
            assert(violation, 'Should detect geography label misuse');
        });

        test('Allows correct geography usage "Ð’Ð¸Ð½Ð° ÐŸÑŒÐµÐ¼Ð¾Ð½Ñ‚Ð°"', () => {
            const text = 'Ð’Ð¸Ð½Ð° ÐŸÑŒÐµÐ¼Ð¾Ð½Ñ‚Ð° Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'GEOGRAPHY_LABEL_MISUSE');
            assert(!violation, 'Should allow "Ð²Ð¸Ð½Ð° ÐŸÑŒÐµÐ¼Ð¾Ð½Ñ‚Ð°"');
        });

        test('Detects emojis', () => {
            const text = 'Ð’Ð¸Ð½Ð¾ ðŸ· Ð´Ð»Ñ Ð²Ð°Ñ';
            const result = validateEmail(`Ð¢Ð•ÐœÐ\n1. ${text}`, {}, { variantCounts: { subject: 1 } });
            const violation = result.violations.find(v => v.code === 'EMOJI_FORBIDDEN');
            assert(violation, 'Should detect emoji');
        });

        // Display summary
        summary.innerHTML = `
            <h2>Test Summary</h2>
            <div class="stats">
                <div class="stat pass">âœ“ ${passed} Passed</div>
                <div class="stat fail">âœ— ${failed} Failed</div>
                <div class="stat">Total: ${passed + failed}</div>
            </div>
        `;
    </script>
</body>
</html>
